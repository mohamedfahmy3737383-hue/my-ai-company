import streamlit as st
import pandas as pd
import requests
import time

st.set_page_config(page_title="Global Market Dominator", layout="wide")

st.title("๐ ุฑุงุฏุงุฑ ุงูุณูุทุฑุฉ ุงูุดุงููุฉ (ูุงูุฉ ุนููุงุช ุงูุนุงูู)")
st.write("ุงูุฑุงุฏุงุฑ ูุฑุงูุจ ุงูุขู ุขูุงู ุงูุนููุงุช ูุงุตุทูุงุฏ ุฃููู ุงูุงููุฌุงุฑุงุช ุงูุณุนุฑูุฉ")

# ุฅุฏุงุฑุฉ ุงููุญูุธุฉ
st.sidebar.title("๐ฐ ุดุฑูุฉ ุงูู 100 ุฌููู")
user_asset = st.sidebar.selectbox("ุงุฎุชุฑ ุนููุชู ูููุชุงุจุนุฉ:", ["PEPE", "SHIB", "DOGE", "BTC", "SOL", "LUNC"])
buy_p = st.sidebar.number_input("ุณุนุฑ ุดุฑุงุก ุนููุชู ($):", value=0.000001, format="%.8f")

def get_all_world_assets():
    # ุณุญุจ ุจูุงูุงุช ุงูู 2000 ุนููุฉ ุงูุฃูุงุฆู ูู ุงูุนุงูู (ุชุบุทูุฉ ุดุงููุฉ)
    try:
        url = "https://api.coincap.io/v2/assets?limit=2000"
        r = requests.get(url, timeout=10)
        if r.status_code == 200:
            return r.json().get('data', [])
    except:
        return None
    return None

placeholder = st.empty()

while True:
    all_data = get_all_world_assets()
    
    if all_data:
        results = []
        for item in all_data:
            try:
                p = float(item.get('priceUsd', 0))
                c = float(item.get('changePercent24Hr', 0))
                v = float(item.get('volumeUsd24Hr', 0))
                sym = item.get('symbol')
                
                results.append({
                    "ุงูุชุฑุชูุจ": int(item.get('rank')),
                    "ุงูุนููุฉ": sym,
                    "ุงูุงุณู": item.get('name'),
                    "ุงูุณุนุฑ ($)": p,
                    "ุชุบูุฑ %": round(c, 2),
                    "ุงูุณูููุฉ (24ุณ)": v,
                    "ุงููุฑุงุฑ": "๐ ุงููุฌุงุฑ" if c > 15 else "๐ฅ ุตุนูุฏ ููู" if c > 7 else "๐ก ูุณุชูุฑ"
                })
            except: continue

        df_all = pd.DataFrame(results)

        with placeholder.container():
            # 1. ูุณู ุงูุงููุฌุงุฑุงุช ุงููุญุธูุฉ (ุฃุนูู 5 ุนููุงุช ูู ุงูุนุงูู ุญุงููุงู)
            st.subheader("โ๏ธ ุฃูุจุฑ ุงููุฌุงุฑุงุช ูู ุงูุนุงูู ุงูุขู")
            top_explosions = df_all.sort_values(by="ุชุบูุฑ %", ascending=False).head(5)
            cols = st.columns(5)
            for i, (index, row) in enumerate(top_explosions.iterrows()):
                cols[i].metric(row['ุงูุนููุฉ'], f"${row['ุงูุณุนุฑ ($)']:.4f}", f"{row['ุชุบูุฑ %']}%")

            st.write("---")

            # 2. ุญุณุงุจุงุช ุงูู 100 ุฌููู ููุนููุฉ ุงููุฎุชุงุฑุฉ
            my_coin = df_all[df_all['ุงูุนููุฉ'] == user_asset].iloc[0] if user_asset in df_all['ุงูุนููุฉ'].values else results[0]
            val_egp = ((2.0 / buy_p) * my_coin['ุงูุณุนุฑ ($)']) * 50 if buy_p > 0 else 100
            
            c1, c2, c3 = st.columns(3)
            c1.metric(f"ูููุฉ ุงูู 100ุฌ ูู {user_asset}", f"{val_egp:.2f} ุฌ.ู", f"{val_egp-100:.2f}")
            c2.metric("ุฅุฌูุงูู ุงูุนููุงุช ุงููุฑุงูุจุฉ", f"{len(df_all)}")
            c3.metric("ุชูููุช ุงูุณูุทุฑุฉ", time.strftime('%H:%M:%S'))

            # 3. ุฌุฏูู ุงูุณูุทุฑุฉ ุงูุดุงูู (ูุงุจู ููุจุญุซ ูุงูุชุฑุชูุจ)
            st.subheader("๐ ูุงุฆูุฉ ุงูุนููุงุช ุงูุนุงูููุฉ (ุฑุชุจ ุญุณุจ ุงูุชุบูุฑ ุฃู ุงูุณูููุฉ)")
            
            # ููุชุฑ ุณุฑูุน ููุจุญุซ
            search = st.text_input("๐ ุงุจุญุซ ุนู ุฃู ุนููุฉ ูู ุงูุนุงูู (ูุซูุงู: BONK, FLOKI, BTC):")
            if search:
                display_df = df_all[df_all['ุงูุนููุฉ'].str.contains(search.upper())]
            else:
                display_df = df_all.head(100) # ุนุฑุถ ุฃูู 100 ุนููุฉ ุงูุชุฑุงุถูุงู ููุณุฑุนุฉ

            st.dataframe(display_df.style.highlight_max(axis=0, subset=['ุชุบูุฑ %']), use_container_width=True)

    else:
        st.warning("๐ ุงูุฑุงุฏุงุฑ ูููู ุจูุณุญ ุขูุงู ุงูุนููุงุช ุงูุขู... ุงูุชุธุฑ ุซูุงูู")

    time.sleep(15) # ุชุญุฏูุซ ูู 15 ุซุงููุฉ ูููุงูุจุฉ ุญุฌู ุงูุจูุงูุงุช ุงูุถุฎู
